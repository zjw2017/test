name: test
on:
  push:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: 1.准备环境
        run: |
          sudo mkdir -p "$GITHUB_WORKSPACE"/corepatch
          Apktool="java -jar "$GITHUB_WORKSPACE"/tools/apktool_2.9.0.jar"
          sudo cp -rf "$GITHUB_WORKSPACE"/services.jar "$GITHUB_WORKSPACE"/corepatch/services.apk
          cd "$GITHUB_WORKSPACE"/corepatch
          sudo $Apktool d -q "$GITHUB_WORKSPACE"/corepatch/services.apk
          target_smali="$GITHUB_WORKSPACE"/corepatch/services/smali/com/android/server/display/DisplayDeviceConfig.smali
          target_line=$(grep -n -E '\.method.*loadPeakDefaultRefreshRate' $target_smali | cut -d: -f1)
          echo $target_line
          end_line=$(sed -n "$target_line,/^\.end method/{p;/\.end method/q}" $target_smali | wc -l)
          end_line=$((target_line + end_line))
          echo $end_line
          sudo sed -i "${target_line},${end_line}d" "$target_smali"
          echo delete
          sudo sed -i "${target_line}i\\
          .method private loadPeakDefaultRefreshRate(Lcom/android/server/display/config/RefreshRateConfigs;)V\\
              .registers 3\\
              .param p1, \"refreshRateConfigs\"  # Lcom/android/server/display/config/RefreshRateConfigs;\\
          \\
              const v0, 0x3c\\
          \\
              iput v0, p0, Lcom/android/server/display/DisplayDeviceConfig;->mDefaultPeakRefreshRate:I\\
          \\
              return-void\\
          .end method\\
          " $target_smali
          cat $target_smali | grep -n "const v0, 0x3c"
          cd "$GITHUB_WORKSPACE"/corepatch/services/
          sudo $Apktool b -q -f -c "$GITHUB_WORKSPACE"/corepatch/services/ -o services.jar
          sudo cp -rf "$GITHUB_WORKSPACE"/corepatch/services/services.jar "$GITHUB_WORKSPACE"/images/system/system/framework/services.jar
          sudo rm -rf "$GITHUB_WORKSPACE"/corepatch
