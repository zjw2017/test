name: test
on:
  workflow_dispatch:
jobs:
  construct_environment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@master
      - name: 1.准备环境
        run: |
          sudo apt install python3 python3-pip aria2 zip p7zip-full tar zipalign zstd dos2unix
          sudo apt --fix-broken install
          sudo apt update --fix-missing
          pip3 install --upgrade pip
          pip3 install pycryptodome
          pip3 install setuptools
          pip3 install docopt
          pip3 install requests
          pip3 install beautifulsoup4
          pip3 install --ignore-installed pyyaml
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone/
          unzip -o -P ${{ secrets.PASSWORD }} "$GITHUB_WORKSPACE"/tools/rclone.zip -d ~/.config/rclone/
  build:
    needs: construct_environment
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device:
          - umi
          - cmi
          - cas
    steps:
      - name: 2.准备变量
        run: |
          if [[ "$device" == "umi" ]]; then
              echo "device=umi" >> $GITHUB_ENV
          elif [[ "$device" == "cmi" ]]; then
              echo "device=cmi" >> $GITHUB_ENV
          elif [[ "$device" == "cas" ]]; then
              echo "device=cas" >> $GITHUB_ENV
          fi
        env:
          device: ${{ matrix.device }}
      - name: 3.下载系统包
        run: |
          if [[ "${{ env.device }}" == "umi" ]]; then
              aria2c -x16 -j$(nproc) -U "Mozilla/5.0" -d "$GITHUB_WORKSPACE" https://hugeota.d.miui.com/V13.0.8.0.SJBCNXM/miui_UMI_V13.0.8.0.SJBCNXM_ade3b2ea7f_12.0.zip
          elif [[ "${{ env.device }}" == "cmi" ]]; then
              aria2c -x16 -j$(nproc) -U "Mozilla/5.0" -d "$GITHUB_WORKSPACE" https://hugeota.d.miui.com/V13.0.6.0.SJACNXM/miui_CMI_V13.0.6.0.SJACNXM_e6f6ed794a_12.0.zip
          elif [[ "${{ env.device }}" == "cas" ]]; then
              aria2c -x16 -j$(nproc) -U "Mozilla/5.0" -d "$GITHUB_WORKSPACE" https://hugeota.d.miui.com/22.10.26/miui_CASPRE_22.10.26_d432264f3a_12.0.zip
          fi
  upload:
    needs: build
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device:
          - umi
          - cmi
          - cas
    steps:
      - name: 4.上传
        run: |
          if [[ "$device" == "umi" ]]; then
              ls -l "$GITHUB_WORKSPACE"
          elif [[ "$device" == "cmi" ]]; then
              ls -l "$GITHUB_WORKSPACE"
          elif [[ "$device" == "cas" ]]; then
              ls -l "$GITHUB_WORKSPACE"
          fi
        env:
          device: ${{ matrix.device }}
