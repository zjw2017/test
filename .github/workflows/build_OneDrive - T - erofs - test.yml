name: 123panpush
on:
  workflow_dispatch:
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        device:
          - umi
    steps:
      - uses: actions/checkout@master
      - name: 1.准备环境
        run: |
          sudo apt install python3 python3-pip aria2 zip p7zip-full tar zipalign zstd
          sudo apt --fix-broken install
          sudo apt update --fix-missing
          pip3 install --upgrade pip
          pip3 install pycryptodome
          pip3 install setuptools
          pip3 install docopt
          pip3 install requests
          pip3 install beautifulsoup4
          pip3 install --ignore-installed pyyaml
          curl https://rclone.org/install.sh | sudo bash
          mkdir -p ~/.config/rclone/
          unzip -P ${{ secrets.PASSWORD }} "$GITHUB_WORKSPACE"/tools/rclone.zip -d ~/.config/rclone/
          curl -fsSL "https://alist.nn.ci/v3.sh" | sudo bash -s install
          sudo systemctl stop alist
          sudo mv -f /home/runner/.config/rclone/data.db-shm /opt/alist/data
          sudo mv -f /home/runner/.config/rclone/data.db-wal /opt/alist/data
          sudo mv -f /home/runner/.config/rclone/data.db /opt/alist/data
          sudo mv -f /home/runner/.config/rclone/config.json /opt/alist/data
          sudo systemctl start alist
      - name: 2.下载系统包
        run: |
          aria2c -x16 -j$(nproc) -U "Mozilla/5.0" -d "$GITHUB_WORKSPACE" https://onedrive.zjw.js.cn/UMI_Packages/miui_UMIPRE_22.9.29_87e182d4ca_12.0_2in1_Root.zip
      - name: 7.上传到123盘
        run: |
          free -m
          rclone mkdir 123pan:/UMI_Packages
          rclone copy -P "$GITHUB_WORKSPACE"/miui_UMIPRE_22.9.29_87e182d4ca_12.0_2in1_Root.zip 123pan:/UMI_Packages --buffer-size=1024M
      - name: 10.删除工作流运行
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 0